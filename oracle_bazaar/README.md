# 预言机集市

去中心化的预言机市场

**Shravan Shandilya, Sumanth Neppalli**
**Keyport**

## 摘要

比特币是一个全球化账本，具有确定性的脚本执行能力。但是，脚本需要外部的输入，如股票价格，游戏结果，保险，预测等等，所以需要称为预言机的外部系统。我们设想一个相互竞争的预言机市场，以提供外部数据作为输入。在一个半信任的预言机系统中，通过竞争成为最可靠和最值得信赖的验证者，这将会大大减少对预言机的信任成本。智能合约可以这样被创建：需要多个预言机对事件的输出达成一致。预言机只负责外部输入，而不在资金管理方面扮演任何角色。

## 介绍

智能合约是一种程序，它正式地编码特定的情况和输出。代码是合约的参与方都同意的，并且必须被忠实执行。预言机是向智能合约提供有关外部世界信息的实体，并将收集到的信息与合约代码的执行相结合。一些智能合约系统，包括比特币内置的，都是严格确定的。为了与现实世界进行交互，这些系统依赖外部系统，即“预言机”，提交的加密签名。[1]

预言机是被信任的实体，它们对世界的状态作出声明。由于可以确定性地完成对声明的验证，所以它使得确定性的合同可以对非确定性的世界做出反应。

最基本的预言机实现是单预言机。单预言机的问题在于需要信任预言机不会作弊。预言机可能会被黑，或者在下注之后消失。下注者和预言机可能会串通。一个半信任的预言机系统，通过竞争成为最可靠和最值得信赖的验证者，这将会大大减少对预言机的信任成本[2]。合约的条件可以被设置成当 n 个预言机中的 m 个有一致的输出时，才执行合约。这样即使有少数的预言机无法发布结果，合约仍然可以执行。合约可以具有这样的条件：如果所有其它条件都失败了，或者参与者对一个结果无法接受，他们可以决定通过无信任的交换来取消合约。

## 预言机市场

我们设想，预言机将成为一个竞争性业务，多个预言机将参与合同条件。即使一方成功地与一个预言机串通，并且预言机发布了对其有利的错误结果，该方也将无法执行合同，因为合同具有附加条件，例如要求 n 个 预言机中的 m 个达成相同的结果。想要作弊必须与所有的预言机勾结，并且还要满足之前设定的任何其他条件。

事件和事件结果是公开的，发布正确结果符合预言机的最佳利益。任何发布错误结果的预言机都可以从区块链上被审查，并且随着其声誉的下降而受到市场的惩罚。投注参与者可以同意使用具有较高声誉的预言机，以确保交易对手和预言机之间串通的风险较小。任何收费过高的预言机都会被迅速提醒，它正在自由市场上竞争，用户正在使用相互竞争的服务。

可以在两个参与者爱丽丝和鲍勃之间查看一般的流程，这可以扩展到更多参与者：

- 在爱丽丝和鲍勃就有条件的赌注达成一致后，他们就如何验证预言机的结果的条件达成一致 - 他们可以选择 n 个中的 m 个必须同意的结果，或者至少 m 个必须就结果达成一致，等等。
- 他们观察预言机市场并评估每个预言机的声誉和每个结果的价格。他们在审查之后就选择预言机达成共识。
- 他们将事件和结果预测发送给预言机。预言机评估此事件并决定他是否可以在预测的事件发生之后产生结果。如果预言机同意参与，他会用他的私钥签署不同结果的预测。然后他发送这些签名的哈希给爱丽丝和鲍勃[3]。爱丽丝和鲍勃用不同的预言机重复这个流程。
- 这些事件保存在每个预言机的数据库中，并且在事件发生之后，每个预言机仅发布评估实际结果的签名。
- 预言机可以以无信任的方式交换此签名以获得支付。爱丽丝和鲍勃之间的赢家支付了所需数量的预言机，声明所有不同签名的结果并解锁输出。
- 如果爱丽丝和鲍勃决定随时取消投注，他们可以以双方同意的价格以无信任的方式这样做。

## 表现形式

爱丽丝和鲍勃想要在某个事件E上下注。此事件可能有多种可能的结果。我们使用符号 Pn 来表示事件的第 n 个可能结果。
这些事件是现实生活事件，因此无法以数学方式计算结果。需要有一个预言机可以验证事件的结果并将该信息发布到区块链上。

为简单起见，我们将使用一个只有两个可能的结果 P1 和 P2 以及一个预言机 O1 的事件。

任何游戏的标准表示都可以参照下面的格式：

```
<identifier>:<outcomes>=<result>

	where,
		identifier: 		HASH160(可能结果的列表)
		outcomes: 		P1,P2,P3,P4 ….. Pn
		result: 		由预言机 O1 验证的结果
```

例子：

在具有 P1，P2 可能结果的游戏中，如果 P1 证实为实际结果，则表示如下：

```
Identifier:		HASH160(P1,P2)
              =HASH160(0x50312c5032)
              =0xa7655aa0ebebfc1e8983ac71789912b4985643f2
Outcomes: 	P1,P2
Result:			P1

representation: 0xa7655aa0ebebfc1e8983ac71789912b4985643f2:P1,P2:P1
```

## 框架

我们描述的框架取决于可信赖的第三方预言机发布某些现实生活事件的结果。参与游戏的各方可以自由选择使用哪个预言机。预言机可以收取服务费。

该框架还涵盖了预言机无法运行的情况。但是，它可以扩展为使用多个竞争的冗余预言机（事先商定）以确保游戏仍然可以继续。

让我们考虑一个简单的游戏，其中爱丽丝和鲍勃希望基于任何现实生活事件 E 创建一个游戏，只有两个可能的结果 P1，P2。 爱丽丝和鲍勃都同意使用预言机 O1 进行游戏。 爱丽丝预测结果为 P1，鲍勃预测结果为 P2。

**游戏表现**:

```
Alice:  	0xa7655aa0ebebfc1e8983ac71789912b4985643f2:P1,P2:P1 = GA
Bob: 	    0xa7655aa0ebebfc1e8983ac71789912b4985643f2:P1,P2:P2 = GB
```

游戏的构造和执行可以被分解成如下步骤：

## 游戏构造

**第1步**：
爱丽丝和鲍勃独立生成秘密。他们计算各自秘密的 HASH160 并相互共享哈希。

SA = 爱丽丝生成的秘密。 （鲍勃不知道这个）
SB = 鲍勃生成的秘密。 （爱丽丝不知道这个）
HASH160 = RIPEMD160(SHA256(data))

**第2步**：
爱丽丝向预言机请求当实际事件 E 发生且结果有利于爱丽丝时，将由预言机生成的签名的 HASH160。
预言机计算 GA 的签名并计算签名的哈希值并将其返回给爱丽丝。

类似地，鲍勃请求当事件结果支持鲍勃时，将由预言机生成的签名的 HASH160。
爱丽丝和鲍勃交换了他们从预言机获得的哈希值。他们两个都可以独立验证对方的哈希值，以确保他们在合适的球队投注并且不会被欺骗。

**第3步**：
既然爱丽丝和鲍勃都拥有他们需要的所有哈希值，那么任何人都可以创建一个哈希锁定的锁定脚本来保存与游戏相关的资金。

## 构建哈希锁智能合约

该脚本的设计使其在以下任何条件下都可以解锁：
爱丽丝产生了她的秘密，预言机发布了有利于爱丽丝预测的签名
鲍勃产生了他的秘密，预言机发布了有利于鲍勃预测的签名
爱丽丝和鲍勃都产生了他们的秘密。

爱丽丝或鲍勃都可以创建这个智能合约。在为智能合约提供资金之前，任何人都可以轻松验证对方是否试图作弊。

我们继续这个过程，假设爱丽丝负责创建智能合约。

**第4步**：
爱丽丝使用她在前面步骤中收集的所有哈希值，使用上面的哈希锁定智能合约创建 scriptPubKey。她创建了一个交易，该交易花费她自己的一个UTXO并将游戏中涉及的总金额转移到由 scriptPubKey 控制的智能合约。爱丽丝用 SIGHASH_ALL 或者SIGHASH_ANYONECANPAY 签名方案。 [4]
重要的是要注意当爱丽丝创建交易时输入金额小于输出金额，因此如果没有鲍勃添加他的资金份额，交易将被网络拒绝。

爱丽丝将签名的交易交给鲍勃。 鲍勃验证交易以检查 scriptPubKey 是否与他生成的内容匹配。如果验证成功，他会附加他的输入，签署交易并广播交易。

## 游戏执行

该游戏现在已经构建完成并持有爱丽丝和鲍勃提供的资金。 现在有两种可能性：

**事件 E 发生时，预言机会发布结果**：
让我们假设事件发生有利于爱丽丝，预言机发布了爱丽丝预测的签名。现在，爱丽丝可以通过提供她的秘密和预言机发布的签名来创建一个由智能合约锁定资金的交易。 如果事件发生有利于鲍勃，他会遵循相同的程序并收集所有奖励。关键是预言机将始终发布事件实际结果的签名。 如图所示，始终如实，符合预言机的最佳利益。

**预言机未能报告事件E的结果**：
爱丽丝和鲍勃都可以决定取消比赛，并从基金中收回他们的公平份额。在这种情况下，锁定脚本由哈希锁定脚本的第三个条件解锁，如上所述。但是，由于他们两个都必须向对方泄露他们的秘密并希望对方不会作弊，所以会涉及到一点信任。
 
秘密的无信任交换可以通过如下方式实现，爱丽丝创建了另一个交易，该交易支付了鲍勃所投注的金额，并与鲍勃的秘密进行了哈希锁定[5]。鲍勃产生了他的秘密以获得他的份额。现在，爱丽丝可以获得鲍勃的秘密 SB，因为它是公开的，并将其与她的秘密 SA 合并并获得所有资金。感觉就像爱丽丝已经获得了所有的资金，但是当爱丽丝已经付给鲍勃时，我们可以看到爱丽丝和鲍勃都只获得了最初的下注。

在没有预言机的情况下，可以进一步使用无信任的秘密交换来继续游戏。让我们假设预言机脱机并且爱丽丝赢了。爱丽丝决定至少获得90％的资金。她可以创建锁定到鲍勃的秘密的哈希锁定事务，并向他支付10％的资金金额。鲍勃可以选择这个选项，或者进行谈判直到达成共识。

## 总结

通过分散的预言机市场将现实世界事件与比特币脚本语言相结合，具有深远的影响。其他区块链（如以太坊）被吹捧的强大智能合约可以以确保代码中没有安全漏洞的方式提供给比特币。半信任的预言机将在未来发挥重要作用，并可能改变诸如保险，赌博，拍卖，衍生品，贷款等业务。许多商业机会将出现，例如为预言机建立声誉系统等等。

## 引用

- Codius white paper https://github.com/codius/codius/wiki/Smart-Oracles:-A-Simple,-Powerful-Approach-to-Smart-Contracts
- Gavin Andresen’s blog on Bit-thereum http://gavintech.blogspot.com/2014/06/bit-thereum.html
- Mike Hearn on Contracts https://en.bitcoin.it/wiki/Contract#Example_4:_Using_external_state
- Similar to step 4 of Jonald Fyookball’s Chainbet proposal https://github.com/fyookball/ChainBet
- Clemens Ley on Trustless exchange https://www.youtube.com/watch?v=M6j-11H2O7c&feature=youtu.be&t=172